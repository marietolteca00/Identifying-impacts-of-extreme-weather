---
title: "Identifying_impacts_extreme_weather"
author: "Marie Tolteca"
date: 10/28/2025
format: html
---

## Learning outcomes

This assignment will reinforce key concepts in geospatial analysis by practicing the following:

-   **load vector/raster data**
-   **simple raster operations**
-   **simple vector operations**
-   **spatial joins**

## Background

Climate change is increasing the frequency and intensity of extreme weather events, with devastating impacts. “In February 2021, the state of Texas suffered a major power crisis, which came about as a result of three severe winter storms sweeping across the United States on February 10–11, 13–17, and 15–20.”1 For more background, check out these engineering and political perspectives.

In this assignment, you will identify the impacts of these series of extreme winter storms by estimating the number of homes in the Houston metropolitan area that lost power and investigate whether not these impacts were disproportionately felt.

Your analysis will be based on remotely-sensed night lights data, acquired from the Visible Infrared Imaging Radiometer Suite (VIIRS) onboard the Suomi satellite. In particular, you will use the VNP46A1 to detect differences in night lights before and after the storm to identify areas that lost electric power.

To determine the number of homes that lost power, you link (spatially join) these areas with OpenStreetMap data on buildings and roads.

To investigate potential socioeconomic factors that influenced recovery, you will link your analysis with data from the US Census Bureau.

# Import Libraries

```{r, message = FALSE}
library(terra) # raster handling
library(tidyverse)
library(tmap) # map making
library(kableExtra) # table formatting
library(spData) # spatial data
library(spDataLarge) # spatial data
library(geodata) # spatial data
library(here)
library(sf)
library(raster)
```

# Importing in Data
```{r}
texas <- st_read(here::here('data','ACS_2019_5YR_TRACT_48_TEXAS.gdb'),
                 layer ='ACS_2019_5YR_TRACT_48_TEXAS' )


homes <- st_read(here('data','gis_osm_buildings_a_free_1.gpkg'), 
                 query = "SELECT * FROM gis_osm_buildings_a_free_1 WHERE (type IS NULL AND name IS NULL)")


roads <- st_read(here('data','gis_osm_roads_free_1.gpkg'),
                 query = "SELECT * FROM gis_osm_roads_free_1 WHERE fclass='motorway'")

# Raster Data - 
vnp_05 <- rast(here("data", "VNP46A1", "VNP46A1.A2021038.h08v05.001.2021039064328.tif"))
vnp_06 <- rast(here("data", "VNP46A1", "VNP46A1.A2021038.h08v06.001.2021039064329.tif"))
vnp_05_2 <- rast(here("data", "VNP46A1", "VNP46A1.A2021047.h08v05.001.2021048091106.tif"))
vnp_06_2 <- rast(here("data", "VNP46A1", "VNP46A1.A2021047.h08v06.001.2021048091105.tif"))

```

### Workflow outline
To complete complete the tasks of this assignment, you will need to break your analysis into the following key steps:

- find locations that experienced a blackout by creating a mask *HINT: this will require creating a raster object for each day (2021-02-07 and 2021-02-16)*
: Check CRS of VNP raster files, combine, find difference, into night light intensity caused by storm between dates of interest. 
:
- exclude highways from analysis
: 
- identify homes that experienced blackouts by combining the locations of homes and blackouts
- identify the census tracts likely impacted by blackout
- Below is guidance and suggestions for each of these steps.

*Tip*
For improved computational efficiency and easier interoperability with sf, I recommend using the stars package for raster handling.


## Check CRS
```{r}
# Transform CRS
# st_crs(texas)
# st_crs(homes)
#texas <- st_transform(homes, crs = st_crs(texas))

# Checking Extents:
if(st_crs(vnp_05) == st_crs(vnp_06)){
  print("Extents match :)")
}  else{
  warning("extents do not match :(")
}

# Check Boundaries of Rasters
# st_bbox(vnp_05) #xmin= -100, xmax= 30, ymin= -90, ymax=40
# st_bbox(vnp_06) # -100   20  -90   30
# st_bbox(vnp_05_2) # -100   30  -90   40 
# st_bbox(vnp_06_2) # -100   20  -90   30 
```
## Creating Raster Objects
```{r}
# Combining Rasters: Using xmin and xmax
vnp_feb07 <- merge(vnp_05, vnp_06)
vnp_feb16 <- merge(vnp_05_2, vnp_06_2)

# Checking if bounding box are the same
st_bbox(vnp_feb07)
st_bbox(vnp_feb16)

# Computing the Difference
vnp_change <- (vnp_feb07) - (vnp_feb16)

# Viewing shape of raster combined
tm_shape(vnp_change) +
    # Add OpenStreetMap as the basemap
  tm_basemap(server = "OpenStreetMap") +
  tm_raster(col.legend = tm_legend(""))+
  tm_title("Difference Map")

```
## Reclassify the difference raster, assuming that any location that experienced a *drop of more than 200 nW cm-2sr-1* experienced a blackout
- Assign `NA` to *all locations* that experienced a drop of less than 200 nW cm-2sr-1 change

```{r}
# Define the reclassification matrix 
rcl_vnp <- matrix(c(-Inf, 200, NA,   # values -Inf to 200 = NA
                    200, Inf, 1),    # values 200 to Inf = 1
                  ncol = 3, byrow = TRUE)

# Apply the matrix using terra::classify
reclassified <- terra::classify(vnp_change, rcl = rcl_vnp)

reclassified_map <- tm_shape(reclassified)+
  tm_raster()
```

##vectorize the blackout mask
hint: use st_as_sf() to convert from a raster to a vector and fix any invalid geometries with st_make_valid()
```{r}
blackout_vector <- st_as_stars(reclassified)%>% 
  st_as_sf() %>% 
  st_make_valid()
```
# Crop (spatially subset) the blackout mask to the Houston area as defined by the following coordinates:(-96.5, 29), (-96.5, 30.5), (-94.5, 30.5), (-94.5, 29)
```{r}
# Define bounding box coordinates
blackout_houston_bounds <- c(xmin = -96.5, xmax = -94.5,
                             ymin = 29, ymax = 30.5)

# Creating bbox and assign CRS
houston_bbox <- st_bbox(blackout_houston_bounds, crs = st_crs(vnp_feb07))

# Convert bbox to an sf polygon
houston_bbox_sf <- st_as_sfc(houston_bbox)

# Crop the vectorized blackout map to Houston area
blackout_houston <- st_intersection(blackout_vector, houston_bbox_sf)

```

```{r, message=FALSE}
## re-project the cropped blackout dataset to *EPSG:3083* (NAD83 / Texas Centric Albers Equal Area)?
# Reprojecting vector to EPSG:3083
blackout_houston_proj <- st_transform(blackout_houston, crs = 3083)
# Checking CRS
#st_crs(blackout_houston_proj)

tm_shape(blackout_houston_proj) +
    # Add OpenStreetMap as the basemap
  tm_basemap(server = "OpenStreetMap") +
  tm_polygons()+
  tm_layout(main.title = "Blackout Map of Houston, Texas",
            main.title.size = 1.5)+
  tm_add_legend(
    type = "fill",
    labels = "Blackout Areas",
    col = "gray30",
    title = "Locations"
  )
```
## Exclude highways from the cropped blackout mask
- Highways may have experienced changes in their night light intensities that are unrelated to the storm. Therefore, you should excluded any locations within 200 meters of all highways in the Houston area.
#identify areas within 200m of all highways - hint: you may need to use st_union
```{r}
# Checking Extents:
if(st_crs(blackout_houston_proj) == st_crs(roads)){
  print("Extents match :)")
}  else{
  warning("extents do not match :(")
}
#Checking Units
st_crs(roads, parameters = TRUE)$units_gdal # Degrees

# Transform
highway <- st_transform(roads, st_crs(blackout_houston_proj))

#Checking Units
st_crs(highway, parameters = TRUE)$units_gdal # Metres

# Confirming Extents:
if(st_crs(blackout_houston_proj) == st_crs(highway)){
  print("Extents match :)")
}  else{
  warning("extents do not match :(")
}

# Creating buffer
highway_200 <- st_buffer(highway, dist = 200) %>% 
  st_union()

# Difference in blackout houston project and highway buffer 200 m
highway_blackouts <- st_difference(blackout_houston_proj, highway_200)


# MAP
tm_basemap("OpenStreetMap") +
  tm_shape(highway_blackouts) +
  tm_polygons(col = "gray30", border.col = NA, alpha = 0.6) +
  tm_shape(highway_200) +
  tm_borders(col = "deeppink", lwd = 1) +
  tm_layout(main.title = "Houston Blackouts Highways(Buffer of 200m)",
            main.title.size = 1.5)+
  tm_add_legend(
    type = "fill",
    labels = c("Blackout Area (Excluding Highways)", "Highways (200 m Buffer)"),
    col = c("gray30", "deeppink"),
    title = "Legend"
  )

```

## Identify the number of homes likely impacted by blackouts
- identify homes that overlap with areas that experienced blackouts
```{r, message=FALSE}
# Transform homes to match CRS
buildings <- st_transform(homes, st_crs(highway_blackouts))

# Verify
if (st_crs(highway_blackouts) == st_crs(buildings)) {
  print("CRS match :)")
} else {
  warning("CRS do not match ️:(")
}

# homes that overlap with blackout areas
building_overlaps <- st_intersects(buildings, highway_blackouts)

# homes impacted (Boolean- TRUE/FALSE)
impacted <- lengths(building_overlaps) > 0

blackout_buildings <- buildings[impacted, ]

# Count how many homes are impacted
impacted_count <- sum(buildings$impacted)
print(paste("Number of homes likely impacted by blackouts:", impacted_count))

# Switching polygons to points
building_points <- st_centroid(buildings)

# Switching polygons to points
blackout_buildings_points <- st_centroid(blackout_buildings)

# MAP
tm_shape(building_points) +
  # Add OpenStreetMap as the basemap
  tm_basemap(server = "OpenStreetMap") + 
  tm_dots(col = "black", size = 0.05, alpha = 0.5,
          title = "Homes (Not Impacted)") +
tm_shape(blackout_buildings_points) +
  tm_dots(col = "darkorchid", size = 0.05, alpha = 0.8,
          title = "Homes Impacted by Blackouts") +
  tm_layout(main.title = "Homes Impacted by Blackout",
            main.title.size = 1.2)+
tm_add_legend(type = "symbol",
              labels = c("Not Impacted", "Impacted by Blackouts"),
              col = c("black", "darkorchid"),
              title = "Homes")


```


# SOCIOECONOMIC PART
# Need geom and Icome layer

```{r}
# Viewing what is in the geodatabase
st_layers(here::here('data','ACS_2019_5YR_TRACT_48_TEXAS.gdb'))



```




