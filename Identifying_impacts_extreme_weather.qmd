---
title: "Identifying_impacts_extreme_weather"
author: "Marie Tolteca"
date: 10/28/2025
format: html
---

## Learning outcomes

This assignment will reinforce key concepts in geospatial analysis by practicing the following:

-   **load vector/raster data**
-   **simple raster operations**
-   **simple vector operations**
-   **spatial joins**

## Background

Climate change is increasing the frequency and intensity of extreme weather events, with devastating impacts. “In February 2021, the state of Texas suffered a major power crisis, which came about as a result of three severe winter storms sweeping across the United States on February 10–11, 13–17, and 15–20.”1 For more background, check out these engineering and political perspectives.

In this assignment, you will identify the impacts of these series of extreme winter storms by estimating the number of homes in the Houston metropolitan area that lost power and investigate whether not these impacts were disproportionately felt.

Your analysis will be based on remotely-sensed night lights data, acquired from the Visible Infrared Imaging Radiometer Suite (VIIRS) onboard the Suomi satellite. In particular, you will use the VNP46A1 to detect differences in night lights before and after the storm to identify areas that lost electric power.

To determine the number of homes that lost power, you link (spatially join) these areas with OpenStreetMap data on buildings and roads.

To investigate potential socioeconomic factors that influenced recovery, you will link your analysis with data from the US Census Bureau.

# Import Libraries

```{r, message = FALSE}
library(terra) # raster handling
library(tidyverse)
library(tmap) # map making
library(kableExtra) # table formatting
library(spData) # spatial data
library(spDataLarge) # spatial data
library(geodata) # spatial data
library(here)
library(stars) # to read data in
library(sf)
```

# Reading in Data
```{r}
texas <- st_read(here::here('data','ACS_2019_5YR_TRACT_48_TEXAS.gdb'),
                 layer ='ACS_2019_5YR_TRACT_48_TEXAS' )

homes <- st_read(here('data','gis_osm_buildings_a_free_1.gpkg'))
roads <- st_read(here('data','gis_osm_roads_free_1.gpkg'))
# Raster Data - 
vnp_05 <- read_stars(here("data", "VNP46A1", "VNP46A1.A2021038.h08v05.001.2021039064328.tif"))
vnp_06 <- read_stars(here("data", "VNP46A1", "VNP46A1.A2021038.h08v06.001.2021039064329.tif"))
vnp_05_2 <- read_stars(here("data", "VNP46A1", "VNP46A1.A2021047.h08v05.001.2021048091106.tif"))
vnp_06_2 <- read_stars(here("data", "VNP46A1", "VNP46A1.A2021047.h08v06.001.2021048091105.tif"))

```

### Workflow outline
To complete complete the tasks of this assignment, you will need to break your analysis into the following key steps:

- find locations that experienced a blackout by creating a mask *HINT: this will require creating a raster object for each day (2021-02-07 and 2021-02-16)*
: Check CRS of VNP raster files, combine, find difference, into night light intensity caused by storm between dates of interest. 
:
- exclude highways from analysis
: 
- identify homes that experienced blackouts by combining the locations of homes and blackouts
- identify the census tracts likely impacted by blackout
- Below is guidance and suggestions for each of these steps.

*Tip*
For improved computational efficiency and easier interoperability with sf, I recommend using the stars package for raster handling.


## Check CRS
```{r}
# Transform CRS
texas <- st_transform(homes, crs = st_crs(texas))

# Checking Extents:
if(st_crs(vnp_05) == st_crs(vnp_06)){
  print("Extents match")
}  else{
  print("extents do not match")
}

# Check Boundaries of Rasters
st_bbox(vnp_05) #xmin= -100, xmax= 30, ymin= -90, ymax=40
st_bbox(vnp_06) # -100   20  -90   30
st_bbox(vnp_05_2) # -100   30  -90   40 
st_bbox(vnp_06_2) # -100   20  -90   30 
```
## Creating Raster Objects
```{r}
# Combining Rasters: Using xmin and xmax
vnp_feb07 <- c(vnp_05, vnp_06, along = 'x')
vnp_feb16 <- c(vnp_05_2, vnp_06_2, along = 'x')


# Mosaic by date: vnp files are separated by arguments.
#vnp_feb07 <- st_mosaic(vnp_05, vnp_06)
#vnp_feb16 <- st_mosaic(vnp_05_2, vnp_06_2)

# Checking if bounding box are the same
st_bbox(vnp_feb07)
st_bbox(vnp_feb16)

# Now you can compute change
vnp_change <- (vnp_feb07) - (vnp_feb16)

# Viewing shape of raster combined
tm_shape(vnp_change) +
  tm_raster()
```
## Reclassify the difference raster, assuming that any location that experienced a *drop of more than 200 nW cm-2sr-1* experienced a blackout
```{r}
# Creating a binary mask: 1 == blackout, 0 == no blackout
blackout_mask[vnp_change <= 200] <- NA
diff_greater <- blackout_mask[vnp_change > 200]


tm_shape(blackout_mask) +
  tm_raster(palette = c("white", "black"),  # white = no blackout, black = blackout
            title = "Blackout Mask" # Title of legend
            ) +
  tm_layout(legend.outside = TRUE) # position of legend
```
## Assign `NA` to *all locations* that experienced a drop of less than 200 nW cm-2sr-1 change
```{r}
# Mask non-blackout areas
#diff_lower <- [vnp_change > 200]


```

